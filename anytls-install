#!/bin/bash

# AnyTLS-Go æœåŠ¡ç«¯ä¸€é”®ç®¡ç†è„šæœ¬ (è‡ªåŠ¨æ›´æ–°å¢žå¼ºç‰ˆ)
# ä»“åº“: https://github.com/anytls/anytls-go

# --- è‡ªåŠ¨èŽ·å– GitHub æœ€æ–°ç‰ˆæœ¬å· ---
echo "æ­£åœ¨æ£€æŸ¥ AnyTLS-Go å®˜æ–¹æœ€æ–°ç‰ˆæœ¬..."
# å¢žåŠ  -k é€‰é¡¹é˜²æ­¢æŸäº›ç³»ç»Ÿè¯ä¹¦è¿‡æœŸå¯¼è‡´æ— æ³•è¿žæŽ¥
ANYTLS_VERSION=$(curl -sk "https://api.github.com/repos/anytls/anytls-go/releases/latest" | grep -Po '"tag_name": "\K.*?(?=")')

if [ -z "$ANYTLS_VERSION" ]; then
    ANYTLS_VERSION="v0.0.11" 
    echo "æç¤ºï¼šæ— æ³•è¿žæŽ¥ GitHub APIï¼Œå°†å®‰è£…ä¿åº•ç‰ˆæœ¬ $ANYTLS_VERSION"
else
    echo "æ£€æµ‹åˆ°å®˜æ–¹æœ€æ–°ç‰ˆæœ¬ä¸º: $ANYTLS_VERSION"
fi

# --- å…¨å±€é…ç½®å‚æ•° ---
BASE_URL="https://github.com/anytls/anytls-go/releases/download"
INSTALL_DIR_TEMP="/tmp/anytls_install_$$"
BIN_DIR="/usr/local/bin"
SERVER_BINARY_NAME="anytls-server"
SERVER_BINARY_PATH="${BIN_DIR}/${SERVER_BINARY_NAME}"
SERVICE_FILE_BASENAME="anytls-server.service"
SERVICE_FILE="/etc/systemd/system/${SERVICE_FILE_BASENAME}"

# --- å·¥å…·å‡½æ•° ---
check_command() { command -v "$1" >/dev/null 2>&1; }

urlencode() {
    local string="${1}"
    local strlen=${#string}
    local encoded=""
    for (( pos=0 ; pos<strlen ; pos++ )); do
       c=${string:$pos:1}
       case "$c" in
          [-_.~a-zA-Z0-9] ) o="${c}" ;;
          * ) printf -v o '%%%02x' "$c"
       esac
       encoded+="${o}"
    done
    echo "${encoded}"
}

get_public_ip() {
    local ip=$(curl -sk --max-time 8 --ipv4 https://api.ipify.org || curl -sk --max-time 8 --ipv4 https://ifconfig.me)
    echo "$ip"
}

# --- æ ¸å¿ƒåŠŸèƒ½ ---
do_install() {
    [ "$(id -u)" -ne 0 ] && echo "é”™è¯¯: è¯·ä½¿ç”¨ sudo è¿è¡Œ" && exit 1
    
    # å°è¯•ä»ŽçŽ°æœ‰æœåŠ¡è¯»å–æ—§ç«¯å£
    local OLD_PORT=$(grep -Po 'ExecStart=.*-l 0\.0\.0\.0:\K[0-9]+' "${SERVICE_FILE}" 2>/dev/null)
    
    echo "--- AnyTLS-Go æœåŠ¡é…ç½® ---"
    read -r -p "è¯·è¾“å…¥ç›‘å¬ç«¯å£ (é»˜è®¤ ${OLD_PORT:-8443}): " ANYTLS_PORT
    ANYTLS_PORT=${ANYTLS_PORT:-${OLD_PORT:-8443}}
    
    read -r -p "è¯·è¾“å…¥æœåŠ¡å¯†ç  (å¿…å¡«): " ANYTLS_PASSWORD
    if [ -z "$ANYTLS_PASSWORD" ]; then echo "é”™è¯¯: å¯†ç ä¸èƒ½ä¸ºç©º"; exit 1; fi

    # å®‰è£…ä¾èµ–
    if check_command apt-get; then
        apt-get update -qq && apt-get install -y -qq wget unzip curl qrencode
    elif check_command yum; then
        yum install -y -q wget unzip curl qrencode
    fi

    # æž¶æž„æ£€æµ‹
    local ARCH=$(uname -m)
    case $ARCH in
        x86_64) ANYTLS_ARCH="amd64" ;;
        aarch64|arm64) ANYTLS_ARCH="arm64" ;;
        *) echo "é”™è¯¯: ä¸æ”¯æŒçš„æž¶æž„ $ARCH"; exit 1 ;;
    esac

    # ä¸‹è½½
    local FILENAME="anytls_${ANYTLS_VERSION#v}_linux_${ANYTLS_ARCH}.zip"
    mkdir -p "$INSTALL_DIR_TEMP"
    echo "æ­£åœ¨ä»Ž GitHub ä¸‹è½½æœ€æ–°ç»„ä»¶..."
    wget -q -O "${INSTALL_DIR_TEMP}/${FILENAME}" "${BASE_URL}/${ANYTLS_VERSION}/${FILENAME}"
    unzip -q -o "${INSTALL_DIR_TEMP}/${FILENAME}" -d "$INSTALL_DIR_TEMP"

    # æ›¿æ¢ç¨‹åº
    systemctl stop "${SERVICE_FILE_BASENAME}" 2>/dev/null
    mv "${INSTALL_DIR_TEMP}/${SERVER_BINARY_NAME}" "${SERVER_BINARY_PATH}"
    chmod +x "${SERVER_BINARY_PATH}"

    # åˆ›å»ºæœåŠ¡ (æ¢å¤å®Œæ•´æ—¥å¿—è¾“å‡ºå®šä¹‰ï¼Œè§£å†³ç‰ˆæœ¬å·æ˜¾ç¤ºé—®é¢˜)
    cat > "$SERVICE_FILE" << EOF
[Unit]
Description=AnyTLS Server Service (Version ${ANYTLS_VERSION})
After=network.target network-online.target
Wants=network-online.target

[Service]
Type=simple
User=root
ExecStart=${SERVER_BINARY_PATH} -l 0.0.0.0:${ANYTLS_PORT} -p "${ANYTLS_PASSWORD}"
Restart=on-failure
RestartSec=5s
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable "${SERVICE_FILE_BASENAME}"
    systemctl restart "${SERVICE_FILE_BASENAME}"

    echo "-----------------------------------------------"
    echo "ðŸŽ‰ å®‰è£…/å‡çº§å®Œæˆï¼ç‰ˆæœ¬: ${ANYTLS_VERSION}"
    show_qr "$ANYTLS_PORT" "$ANYTLS_PASSWORD"
}

show_qr() {
    local ip=$(get_public_ip)
    local encoded_pass=$(urlencode "$2")
    local remarks=$(urlencode "AnyTLS-${1}")
    local uri="anytls://${encoded_pass}@${ip}:${1}?allowInsecure=true#${remarks}"
    echo "å®¢æˆ·ç«¯é“¾æŽ¥: $uri"
    qrencode -t ANSIUTF8 -m 1 "${uri}"
}

# --- èœå•æŽ§åˆ¶ ---
case "$1" in
    install) do_install ;;
    # è¿™é‡Œçš„ -l å’Œ --no-pager ç¡®ä¿ç‰ˆæœ¬å·æ—¥å¿—èƒ½å®Œæ•´æ˜¾ç¤º
    status) systemctl status "${SERVICE_FILE_BASENAME}" -l --no-pager ;;
    stop) systemctl stop "${SERVICE_FILE_BASENAME}" && echo "æœåŠ¡å·²åœæ­¢" ;;
    restart) systemctl restart "${SERVICE_FILE_BASENAME}" && echo "æœåŠ¡å·²é‡å¯" ;;
    log) journalctl -u "${SERVICE_FILE_BASENAME}" -f ;;
    qr) 
        PORT=$(grep -Po 'ExecStart=.*-l 0\.0\.0\.0:\K[0-9]+' "${SERVICE_FILE}" 2>/dev/null)
        PASS=$(grep -Po 'ExecStart=.*-p "\K[^"]+' "${SERVICE_FILE}" 2>/dev/null || grep -Po 'ExecStart=.*-p \K[^ ]+' "${SERVICE_FILE}")
        show_qr "$PORT" "$PASS" 
        ;;
    *) echo "ç”¨æ³•: $0 {install|status|stop|restart|log|qr}" ;;
esac

# æ¸…ç†
rm -rf "$INSTALL_DIR_TEMP" 2>/dev/null
