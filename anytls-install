#!/bin/bash

# AnyTLS-Go å…¨åŠŸèƒ½ä¸€é”®ç®¡ç†è„šæœ¬ (æ”¯æŒè‡ªåŠ¨å‡çº§)
# ä»“åº“: https://github.com/anytls/anytls-go

# --- è‡ªåŠ¨èŽ·å– GitHub æœ€æ–°ç‰ˆæœ¬å· ---
echo "æ­£åœ¨æ£€æŸ¥ AnyTLS-Go å®˜æ–¹æœ€æ–°ç‰ˆæœ¬..."
ANYTLS_VERSION=$(curl -s "https://api.github.com/repos/anytls/anytls-go/releases/latest" | grep -Po '"tag_name": "\K.*?(?=")')

if [ -z "$ANYTLS_VERSION" ]; then
    ANYTLS_VERSION="v0.0.11" 
    echo "æç¤ºï¼šæ— æ³•è¿žæŽ¥ APIï¼Œå°†å°è¯•å®‰è£…ä¿åº•ç‰ˆæœ¬ $ANYTLS_VERSION"
else
    echo "æ£€æµ‹åˆ°å®˜æ–¹æœ€æ–°ç‰ˆæœ¬ä¸º: $ANYTLS_VERSION"
fi

# --- å…¨å±€é…ç½® ---
BASE_URL="https://github.com/anytls/anytls-go/releases/download"
INSTALL_DIR_TEMP="/tmp/anytls_install_$$"
BIN_DIR="/usr/local/bin"
SERVER_BINARY_NAME="anytls-server"
SERVER_BINARY_PATH="${BIN_DIR}/${SERVER_BINARY_NAME}"
SERVICE_FILE_BASENAME="anytls-server.service"
SERVICE_FILE="/etc/systemd/system/${SERVICE_FILE_BASENAME}"

# --- å·¥å…·å‡½æ•° ---
check_command() { command -v "$1" >/dev/null 2>&1; }

urlencode() {
    local string="${1}"
    local strlen=${#string}
    local encoded=""
    for (( pos=0 ; pos<strlen ; pos++ )); do
       c=${string:$pos:1}
       case "$c" in
          [-_.~a-zA-Z0-9] ) o="${c}" ;;
          * ) printf -v o '%%%02x' "'$c"
       esac
       encoded+="${o}"
    done
    echo "${encoded}"
}

get_public_ip() {
    local ip=$(curl -s --max-time 8 --ipv4 https://api.ipify.org || curl -s --max-time 8 --ipv4 https://ifconfig.me)
    echo "$ip"
}

# --- æ ¸å¿ƒèœå•åŠŸèƒ½ ---

do_install() {
    [ "$(id -u)" -ne 0 ] && echo "é”™è¯¯: å¿…é¡»ä½¿ç”¨ sudo è¿è¡Œ" && exit 1
    
    # è‡ªåŠ¨æå–æ—§é…ç½®
    local OLD_PORT=$(grep -Po 'ExecStart=.*-l 0\.0\.0\.0:\K[0-9]+' "${SERVICE_FILE}" 2>/dev/null)
    local OLD_PASS=$(grep -Po 'ExecStart=.*-p "\K[^"]+' "${SERVICE_FILE}" 2>/dev/null || grep -Po 'ExecStart=.*-p \K[^ ]+' "${SERVICE_FILE}" 2>/dev/null)

    echo "å¼€å§‹å®‰è£…/æ›´æ–° AnyTLS-Go (ç‰ˆæœ¬: ${ANYTLS_VERSION})"
    read -r -p "è¯·è¾“å…¥ç›‘å¬ç«¯å£ (é»˜è®¤ ${OLD_PORT:-8443}): " ANYTLS_PORT
    ANYTLS_PORT=${ANYTLS_PORT:-${OLD_PORT:-8443}}
    
    read -r -p "è¯·è¾“å…¥æœåŠ¡å¯†ç  (é»˜è®¤ ${OLD_PASS:-å¿…å¡«}): " ANYTLS_PASSWORD
    ANYTLS_PASSWORD=${ANYTLS_PASSWORD:-$OLD_PASS}
    [ -z "$ANYTLS_PASSWORD" ] && echo "é”™è¯¯: å¯†ç ä¸èƒ½ä¸ºç©º" && exit 1

    # ä¾èµ–ä¸Žæž¶æž„
    check_command wget || (apt-get update && apt-get install -y wget unzip curl qrencode || yum install -y wget unzip curl qrencode)
    
    ARCH=$(uname -m)
    case $ARCH in
        x86_64|amd64) ANYTLS_ARCH="amd64" ;;
        aarch64|arm64) ANYTLS_ARCH="arm64" ;;
        *) echo "é”™è¯¯: ä¸æ”¯æŒçš„æž¶æž„ $ARCH"; exit 1 ;;
    esac

    # ä¸‹è½½æ›¿æ¢
    FILENAME="anytls_${ANYTLS_VERSION#v}_linux_${ANYTLS_ARCH}.zip"
    mkdir -p "$INSTALL_DIR_TEMP"
    wget -q -O "${INSTALL_DIR_TEMP}/${FILENAME}" "${BASE_URL}/${ANYTLS_VERSION}/${FILENAME}"
    unzip -q -o "${INSTALL_DIR_TEMP}/${FILENAME}" -d "$INSTALL_DIR_TEMP"
    
    systemctl stop "${SERVICE_FILE_BASENAME}" 2>/dev/null
    mv "${INSTALL_DIR_TEMP}/${SERVER_BINARY_NAME}" "${SERVER_BINARY_PATH}"
    chmod +x "${SERVER_BINARY_PATH}"

    # å†™å…¥æœåŠ¡
    cat > "$SERVICE_FILE" << EOF
[Unit]
Description=AnyTLS Server Service
After=network.target

[Service]
Type=simple
User=root
ExecStart=${SERVER_BINARY_PATH} -l 0.0.0.0:${ANYTLS_PORT} -p "${ANYTLS_PASSWORD}"
Restart=on-failure
RestartSec=10s
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable "${SERVICE_FILE_BASENAME}"
    systemctl restart "${SERVICE_FILE_BASENAME}"
    
    echo "ðŸŽ‰ å®‰è£…/æ›´æ–°æˆåŠŸï¼"
    show_qr "$ANYTLS_PORT" "$ANYTLS_PASSWORD"
}

do_uninstall() {
    [ "$(id -u)" -ne 0 ] && echo "é”™è¯¯: å¿…é¡»ä½¿ç”¨ sudo è¿è¡Œ" && exit 1
    systemctl stop "${SERVICE_FILE_BASENAME}"
    systemctl disable "${SERVICE_FILE_BASENAME}"
    rm -f "${SERVICE_FILE}" "${SERVER_BINARY_PATH}"
    systemctl daemon-reload
    echo "AnyTLS å·²å½»åº•ä»Žç³»ç»Ÿä¸­ç§»é™¤ã€‚"
}

show_qr() {
    local ip=$(get_public_ip)
    local encoded_pass=$(urlencode "$2")
    local remarks=$(urlencode "AnyTLS-${1}")
    local uri="anytls://${encoded_pass}@${ip}:${1}?allowInsecure=true#${remarks}"
    echo "-----------------------------------------------"
    echo "é…ç½®é“¾æŽ¥: $uri"
    qrencode -t ANSIUTF8 -m 1 "${uri}"
}

show_help_menu() {
    echo "==============================="
    echo "   AnyTLS-Go æœåŠ¡ç«¯ç®¡ç†è„šæœ¬"
    echo "==============================="
    echo "ç”¨æ³•: $0 [å‘½ä»¤]"
    echo ""
    echo "å¯ç”¨å‘½ä»¤:"
    printf "  %-12s %s\n" "install" "å®‰è£…æˆ–è‡ªåŠ¨æ›´æ–°è‡³æœ€æ–°ç‰ˆ (éœ€è¦sudo)"
    printf "  %-12s %s\n" "uninstall" "å½»åº•å¸è½½ AnyTLS æœåŠ¡ (éœ€è¦sudo)"
    printf "  %-12s %s\n" "start" "å¯åŠ¨æœåŠ¡"
    printf "  %-12s %s\n" "stop" "åœæ­¢æœåŠ¡"
    printf "  %-12s %s\n" "restart" "é‡å¯æœåŠ¡"
    printf "  %-12s %s\n" "status" "æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ä¸Žç‰ˆæœ¬"
    printf "  %-12s %s\n" "log" "å®žæ—¶æŸ¥çœ‹æ—¥å¿— (Ctrl+Cé€€å‡º)"
    printf "  %-12s %s\n" "qr" "é‡æ–°æ˜¾ç¤ºé…ç½®äºŒç»´ç "
    printf "  %-12s %s\n" "help" "æ˜¾ç¤ºæ­¤å¸®åŠ©èœå•"
    echo ""
}

# --- ä¸»ç¨‹åºé€»è¾‘ ---
case "$1" in
    install) do_install ;;
    uninstall) do_uninstall ;;
    start) systemctl start "${SERVICE_FILE_BASENAME}" && echo "æœåŠ¡å·²å¯åŠ¨" ;;
    stop) systemctl stop "${SERVICE_FILE_BASENAME}" && echo "æœåŠ¡å·²åœæ­¢" ;;
    restart) systemctl restart "${SERVICE_FILE_BASENAME}" && echo "æœåŠ¡å·²é‡å¯" ;;
    status) systemctl status "${SERVICE_FILE_BASENAME}" -l --no-pager ;;
    log) journalctl -u "${SERVICE_FILE_BASENAME}" -f ;;
    qr)
        PORT=$(grep -Po 'ExecStart=.*-l 0\.0\.0\.0:\K[0-9]+' "${SERVICE_FILE}" 2>/dev/null)
        PASS=$(grep -Po 'ExecStart=.*-p "\K[^"]+' "${SERVICE_FILE}" 2>/dev/null || grep -Po 'ExecStart=.*-p \K[^ ]+' "${SERVICE_FILE}" 2>/dev/null)
        [ -n "$PORT" ] && show_qr "$PORT" "$PASS" || echo "é”™è¯¯: æœªæ‰¾åˆ°æœåŠ¡é…ç½®"
        ;;
    *) show_help_menu ;;
esac

rm -rf "$INSTALL_DIR_TEMP" 2>/dev/null
